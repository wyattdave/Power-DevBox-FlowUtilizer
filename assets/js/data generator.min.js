const sExceptLink="concat('https://make.powerautomate.com/manage/environments/', workflow()?['tags']?['environmentName']",sExceptLink2="concat('https://make.powerautomate.com/manage/environments/',workflow()?['tags']?['environmentName']",regExFlow=new RegExp("/flows/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvir=new RegExp("/environments/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvirD=new RegExp("/environments/Default-[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExpEnviron=new RegExp("@parameters(.*?)\\)","gm"),regExpEnviron2=new RegExp("@{parameters(.*?)\\)","gm");function CreateReview(e,n,t,r,i,a,o,l){let s=[],c=[],p=[],u=[],f=[],m=[],g=[],d="unknown",y="none",h="none",v="none",N="none",b="none",O="none";""!=o&&null!=o||(o="please input");const x=JSON.parse(e),E=getChildren(x.properties.definition,new Array,0,"root");if(null!=x.properties?.displayName?(n=x.properties.displayName,t=x.name):null!=x.name&&(t=x.name),null!=x.properties?.connectionReferences){Object.keys(x.properties.connectionReferences).forEach((e=>{value=x.properties.connectionReferences[e],null!=value?.connection?.connectionReferenceLogicalName&&g.push({connection:e,referenceName:value.connection.connectionReferenceLogicalName,type:value.api.name})}))}Object.keys(x.properties.definition.triggers).forEach((e=>{value=x.properties.definition.triggers[e],d=e,null!=value?.inputs?.schema&&(y=JSON.stringify(value.inputs)),null!=value?.inputs?.parameters&&(y=JSON.stringify(value.inputs)),null!=value?.inputs?.parameters&&(h=JSON.stringify(value.inputs.parameters)),null!=value?.recurrance&&(O=value.recurrance),null!=value?.conditions&&null!=value.conditions[0]?.expression&&(N=value.conditions[0].expression),null!=value?.inputs?.schema?.properties&&(b=JSON.stringify(value.inputs.schema.properties)),null!=value?.runtimeConfiguration&&(v=JSON.stringify(value.runtimeConfiguration))})),E.forEach(((e,n)=>{let t="MISSING";null!=e.metadata?.operationMetadataId&&(t=e.metadata.operationMetadataId);let i="",o="",l="";"OpenApiConnection"==e.type?(i=e.inputs.host.operationId,o=e.inputs.host.connectionName,l=e.inputs.host.apiId):i=e.type;let c="Standard",p=null;if(""!=o){let e=a.find((e=>e.name.includes(o.substring(0,o.length-2).trim())));"shared_sendmail"==o||"shared_teams"==o?c="Standard":null!=e?(c=e.properties.tier,p=e.properties.iconUri):c="Premium"}let u,f="",g="|",d="Non-Exception";if("{}"==JSON.stringify(e.runAfter)||null==e.runAfter||null==e.runAfter)f=e.parent+":Success";else{Object.keys(e.runAfter).forEach((n=>{g+=n+"|",f=n+":"+JSON.stringify(e.runAfter[n]).replaceAll(","," | "),JSON.stringify(e.runAfter[n]).includes("Failed")&&(d="Exception")}))}"|"==g&&0==e.nestedLevel&&(g="|trigger|"),"|"==g&&0!=e.nestedLevel&&(g="|"+e.parent+"|"),f.length>1&&(f=f.substring(0,f.length-1));let y=r.find((n=>n.Name.includes(i+o)||n.Name==e.type));u=null!=y?Number(y.Complexity):1;let h="";null!=e?.inputs?.parameters?.$filter&&(h=e.inputs.parameters.$filter);let v="",N="";null!=e?.inputs?.retryPolicy&&(v=e.inputs.retryPolicy.type,N=JSON.stringify(e.inputs.retryPolicy));let b="";null!=e?.runtimeConfiguration?.paginationPolicy&&(b=e.runtimeConfiguration.paginationPolicy.minimumItemCount);let O="";null!=e?.runtimeConfiguration?.secureData&&(O=JSON.stringify(e.runtimeConfiguration.secureData).replace('{"properties":[',"").replace("]}","").replaceAll('"',""));let x="";null!=e?.limit?.timeout&&(x=e.limit.timeout);let E="";null!=e?.description&&(E=e.description);let S=e;S.hasOwnProperty("actions")&&delete S.actions;let C=JSON.stringify(removeCircularReferences(S)).match(regExpEnviron),w=!1;C&&(C=C.filter((e=>"@parameters('$authentication')"!=e)),C.length>0&&(w=!0)),w||(C=JSON.stringify(removeCircularReferences(S)).match(regExpEnviron2),C&&(C=C.filter((e=>"@{parameters('$authentication')"!=e)),C.length>0&&(w=!0)));let I="";e.parent==f.split(":")[0]&&(I="Internal");let j="";j=null==e.inputs?"":e.inputs.hasOwnProperty("parameters")?JSON.stringify(e.inputs.parameters):JSON.stringify(e.inputs),e.hasOwnProperty("foreach")&&(j=JSON.stringify(e.foreach)),e.hasOwnProperty("expression")&&(j=JSON.stringify(e.expression)),s.push({name:e.operationName,step:i,type:e.type,id:t,hashId:t+"###"+(n+1),tier:c,connector:o,imgURL:p,runAfter:f.replace(/[\[\]""]/g,""),exception:d,index:n+1,object:e,complexity:u,detail:j,filter:h,pagination:b,secure:O,retry:v,timeout:x,position:g,positionInfo:I,environmentVariables:JSON.stringify(C),environmentB:w,notes:E,parent:e.parent,apiId:l,branch:e.branch}),m.push({step:i,connector:o,name:e.operationName,id:t,hashId:t+"###"+(n+1),object:JSON.stringify(removeCircularReferences(e)),type:e.type,index:n+1,parent:e.parent})})),s.forEach((e=>{if("|trigger|"==e.position)e.positionIndex="|0",e.positionType="|trigger",e.nested="";else{e.positionIndex="",e.positionType="",e.nested="";s.filter((n=>e.position.includes("|"+n.name+"|"))).forEach((n=>{e.positionIndex+="|"+Number(n.index),e.positionType+="|"+n.type;let t=getNesting(e.parent,s)+"";"|0"==t.substring(t.length-2,2)&&(t=t.substring(0,t.length-2)),"0"!=t&&null!=t&&null!=t&&"undefined"!=t||(t=""),e.nested=t}))}}));const S=s.filter((e=>null!=e.detail&&null!=e.detail&&"InitializeVariable"!=e.type));let C,w,I;E.filter((e=>"InitializeVariable"==e.type)).forEach((e=>{let n="",t=!1,r=!1;const a=e.inputs.variables[0],o=S.filter((e=>"string"==typeof e.detail&&e.detail.includes(a.name)));i.data.filter((e=>e.Type==a.type)).length>0&&(n=i.data.find((e=>e.Type==a.type)).Letter),a.name.substring(0,i.char)==n&&(t=!0),""!=a.value&&null!=a.value&&null!=a.value?a.name.substring(1,a.name.length-1)===a.name.substring(1,a.name.length-1).toUpperCase()&&(r=!0):r=!0;let l="";l=isObject(a.value)?JSON.stringify(a.value):null==a.value?"":a.value+"",null==a.value&&(a.value=""),c.push({name:a.name,type:a.type,value:l,used:o.length>0,named:t,local:r})})),getDistinct(s).forEach((e=>{const n=s.find((n=>n.connector==e));let t=n.apiId;const r=g.find((n=>n.connection==e));r&&(t=r.referenceName),p.push({conName:e,appId:t,opId:n.step,count:s.filter((n=>n.connector==e)).length})})),f=s.filter((e=>"OpenApiConnection"==e.type)),u=s.filter((e=>"Exception"==e.exception)),C=0==c.length||c.every((e=>!0===e.named)),w=0==c.length||c.every((e=>!0===e.local)),I=0==c.length||c.every((e=>!0===e.used));let j=u.filter((e=>"Exception"==e.name)),J=!1,A=!1;return j&&(J=j.length>0&&JSON.stringify(j[0].object).includes("Terminate"),A=j.length>0&&(JSON.stringify(j[0].object).includes(sExceptLink)||JSON.stringify(j[0].object).includes(sExceptLink2))),s.forEach((e=>{delete e.object,delete e.apiId;let n=s.find((n=>n.name==e.parent));null!=n&&"If"!=n.type&&"Switch"!=n.type&&(e.branch="")})),{name:n,id:t,environment:l,owner:o,trigger:d,triggerData:h,triggerParam:y,triggerConfig:v,triggerExpress:N,triggerInputs:b,triggerRecur:O,premium:!s.every((e=>"Standard"===e.tier)),connectionRefs:p.length,connectors:f.length,steps:s.length,variables:c.length,complexity:sumObj(s,"complexity"),varNaming:C,varNameConsts:w,varNameUse:I,composes:s.filter((e=>"Compose"==e.type)).length,exception:u.length,exceptionHandleScope:u.filter((e=>"Scope"==e.step)).length>0,exceptionScope:j.length>0,exceptionTerminate:J,exceptionLink:A,mainScope:s.filter((e=>"Main"==e.name)).length>0,variableArray:c,actionArray:s,apiActionArray:f,exceptionArray:u,connectionArray:p,error:"",actionObjectArray:m}}function getNesting(e,n){let t;if("root"!=e){let r=n.find((n=>n.name==e));t=r.index,"root"!=r.parent&&(t+="|"+getNesting(r.parent,n))}return t}function getChildren(e,n,t,r){if(null!=e?.actions){Object.keys(e.actions).forEach((i=>{let a=e.actions[i];a.operationName=i,a.nestedLevel=t,a.parent=r,a.branch="Yes",n.push(a),n=getChildren(a,n,t+1,i)}))}if(null!=e?.else){Object.keys(e.else.actions).forEach((i=>{let a=e.else.actions[i];a.operationName=i,a.nestedLevel=t,a.parent=r,a.branch="No",n.push(a),n=getChildren(a,n,t+1,i)}))}if(null!=e?.cases){Object.keys(e.cases).forEach((i=>{let a=e.cases[i];Object.keys(a.actions).forEach((a=>{let o=e.cases[i].actions[a];o.operationName=a,o.nestedLevel=t,o.parent=r,o.branch=i,n.push(o),n=getChildren(o,n,t+1,a)}))}));Object.keys(e.default.actions).forEach((i=>{let a=e.default.actions[i];a.operationName=i,a.nestedLevel=t,a.parent=r,a.branch="Default",n.push(a),n=getChildren(a,n,t+1,a)}))}return n}function sumObj(e=[],n){let t=0;return t=e.reduce(((e,t)=>e+t[n]),0),t}function getParent(e){return e.sort(((e,n)=>e.value-n.value))[0]}function getDistinct(e){const n=new Set;for(const t of e)""!=t.connector&&n.add(t.connector);return Array.from(n)}function isObject(e){return e&&"object"==typeof e&&e.constructor===Object}function removeCircularReferences(e,n=new WeakSet){return"object"==typeof e&&null!==e?n.has(e)?"[Circular]":(n.add(e),Array.isArray(e)?e.map((e=>removeCircularReferences(e,n))):Object.fromEntries(Object.entries(e).map((([e,t])=>[e,removeCircularReferences(t,n)])))):e}function removeItemById(e,n){return e.filter((e=>e.flow!==n))}function distanceBetween(e,n,t){return Math.abs(e.indexOf(n)-e.indexOf(t))}