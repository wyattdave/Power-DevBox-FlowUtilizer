let oReport,oLiveReport,oHTML,oSaved,oSavedDef,oRatings,oNaming,aComplexity,aScoring,oConfigReference,oSolution,oDependencies,sDefinition="",sDefinitionParsed="",sCustomList=null,aConnectionTier=aConnectionTierBackup.value,i=0,iDefinitionFind=0,iDefinitionCount=0,aEnvironmentVar=[],sEnvironment="",bUpdate=!1,aExceptions=[],aConnectors=[],bFirstFlow=!1;const iResetStorage=8,regExpFileID=new RegExp("[A-Z0-9]{8}-([A-Z0-9]{4}-){3}[A-Z0-9]{12}","m"),sHtml='<html><head><meta name="color-scheme" content="dark"></head><body>',pLoading=document.getElementById("loading"),spanVersion=document.getElementById("version"),divCSV=document.getElementById("csvDropdown"),divAdmin=document.getElementById("admin"),butReview=document.getElementById("review-button"),butReport=document.getElementById("report-button"),butSolution=document.getElementById("solution-button"),butShortcut=document.getElementById("shortcut-button"),divDivider=document.getElementById("solution-divider"),butData=document.getElementById("data-button"),butDiagram=document.getElementById("diagram-button"),butDefinition=document.getElementById("definition-button"),lSolution=document.getElementById("solution-container"),tSolution=document.getElementById("solution-title"),iLoad=document.getElementById("loadSaved"),divConfig=document.getElementById("admin"),buLiveFlow=document.getElementById("loadLive"),butExcept=document.getElementById("exception-button");function DownloadCSV(e,n){const t=aDownloadConfig.find((n=>n.Name==e));let o=oReport.name;if(0==o&&(o="Flow"),t&&null!=n)if("Actions"==e){let e=oReport.actionArray.slice(0);e.forEach((e=>{e.detail=e.detail.replaceAll(",","|"),e.notes=e.notes.replaceAll(",","|"),e.filter=e.filter.replaceAll(",","|"),e.secure=e.secure.replaceAll(",","|"),e.retry=e.retry.replaceAll(",","|"),delete e.environmentVariables,delete e.environmentB,delete e.branch})),exportCSVFile(t.headers,e,o+"-"+t.Name)}else if("Variables"==e){let e=oReport.variableArray.slice(0);e.forEach((e=>{e.value=e.value.replaceAll(",","|"),e.value=e.value.substr(0,200)})),exportCSVFile(t.headers,e,o+"-"+t.Name)}else"Connections"==e&&exportCSVFile(t.headers,oReport.connectionArray,o+"-"+t.Name)}function OpenException(){SaveData(),sessionStorage.setItem("exception",createException(aExceptions,oNaming.data,sExceptionTemplate,oDependencies)),i=sessionStorage.getItem("windowCounter");window.open("exception.html","Exceptions"+(new Date).getTime()+i);i++,sessionStorage.setItem("windowCounter",i)}function OpenReview(){SaveData(),sessionStorage.setItem("actions",JSON.stringify(removeCircularReferences(oReport.actionArray))),sessionStorage.setItem("review",oHTML.review),sessionStorage.setItem("references",oHTML.references),i=sessionStorage.getItem("windowCounter");window.open("review.html","Review"+(new Date).getTime()+i);i++,sessionStorage.setItem("windowCounter",i)}function OpenReport(){SaveData(),sessionStorage.setItem("report",oHTML.report),i=sessionStorage.getItem("windowCounter");window.open("report.html","Report"+(new Date).getTime()+i);i++,sessionStorage.setItem("windowCounter",i)}function OpenDiagram(){SaveData(),sessionStorage.setItem("actions",JSON.stringify(removeCircularReferences(oReport.actionArray))),sessionStorage.setItem("diagram",createDiagram(oReport.actionArray,oReport.name,oReport.trigger,oReport.actionObjectArray)),sessionStorage.setItem("name",oReport.name),sessionStorage.setItem("id",oReport.id);const e={trigger:oReport.trigger,triggerData:oReport.triggerData,triggerParam:oReport.triggerParam,triggerConfig:oReport.triggerConfig,triggerExpress:oReport.triggerExpress,triggerInputs:oReport.triggerInputs,triggerRecur:oReport.triggerRecur};sessionStorage.setItem("trigger",JSON.stringify(e)),window.open("diagram.html")}function OpenData(){SaveData(),i=sessionStorage.getItem("windowCounter");window.open("","Data"+(new Date).getTime()+i).document.write(sHtml+'<p>Schema:<a href="/Configs/AutoReview-Schema.json">https://github.com/davedidisco/Auto-Review-Self-Config/blob/main/AutoReview-Schema.json</a></p><pre>'+JSON.stringify(oReport,void 0,2)+"</pre></body></html>"),i++,sessionStorage.setItem("windowCounter",i)}function OpenDefinition(){SaveData(),i=sessionStorage.getItem("windowCounter");window.open("","Definition"+(new Date).getTime()+i).document.write(sHtml+'<p>Schema:<a href="https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#">https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#</a></p><pre>'+JSON.stringify(sDefinitionParsed,void 0,2)+"</pre></body></html>"),i++,sessionStorage.setItem("windowCounter",i)}function OpenSolution(){SaveData(),i=sessionStorage.getItem("windowCounter"),sessionStorage.setItem("solution",listSolution(oSolution,sSolutionTemplate,aExceptions,aConnectors));window.open("./solution.html","Solution Contents"+(new Date).getTime()+i);i++,sessionStorage.setItem("windowCounter",i)}function OpenShortcut(){alert("ALT+A Open AutoReview Window \nALT+L Load Previous \nALT+R Open Review \nALT+E Open Report \nALT+D Open Diagram \nALT+C Clear Last Saved")}function OpenBug(){window.open(sMailTemplate,"Bug Email")}function loadSavedFlow(){generateReport(oSaved),oReport=oSaved,sDefinitionParsed=oSavedDef,pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+oSaved.name,divDivider.style="display: none",lSolution.style="display: none",tSolution.style="display: none",butSolution.style="display: none",butReview.style="width:100%; display:block",butReport.style="width:100%; display:block",butExcept.style="width:100%; display:block",butData.style="display:block;",butDiagram.style="display:block;  width:100%;",spanVersion.style="display:none;",divCSV.style="display:block; width:100%;",divAdmin.style="display:none;",divConfig.style="display:none;"}function csvAction(){DownloadCSV("Actions",oSaved)}function csvVariables(){DownloadCSV("Variables",oSaved)}function csvConnections(){DownloadCSV("Connections",oSaved)}document.getElementById("review-button").addEventListener("click",OpenReview),document.getElementById("report-button").addEventListener("click",OpenReport),document.getElementById("data-button").addEventListener("click",OpenData),document.getElementById("diagram-button").addEventListener("click",OpenDiagram),document.getElementById("definition-button").addEventListener("click",OpenDefinition),document.getElementById("bugEmail").addEventListener("click",OpenBug),document.getElementById("restConfigs").addEventListener("click",ResetConfigs),document.getElementById("actionsCSVdownload").addEventListener("click",csvAction),document.getElementById("variablesCSVdownload").addEventListener("click",csvVariables),document.getElementById("connectionsCSVdownload").addEventListener("click",csvConnections),document.getElementById("loadSaved").addEventListener("click",loadSavedFlow),document.getElementById("compareFlows").addEventListener("click",OpenCompare),document.getElementById("addCompare-button").addEventListener("click",AddCompare),butExcept.addEventListener("click",OpenException),butSolution.addEventListener("click",OpenSolution),butShortcut.addEventListener("click",OpenShortcut),loadPlatform(pLoading);const fileInput=document.getElementById("file-input"),encodingInput="utf-8",fileInputButton=document.getElementById("file-input-button"),passwordInput="";let entries,selectedFile;async function selectFile(){try{fileInputButton.disabled=!0,unpackNestedZipFiles(fileInput.files[0])}catch(e){}finally{fileInputButton.disabled=!1,fileInput.value=""}}async function unpackNestedZipFiles(e){try{if(aExceptions=[],aEnvironmentVar=[],aConnectors=[],document.getElementById("addCompare-button").style="color: #585858;",pLoading.style.color="black",pLoading.innerText="Loading...",bFirstFlow=!0,e.name.endsWith(".zip")||e.name.endsWith(".msapp")){const n=new zip.ZipReader(new zip.BlobReader(e)),t=await n.getEntries();let o=0;if(t&&t.length){lSolution.style="display: none",divDivider.style="display: none",tSolution.style="display: none",butSolution.style.display="none",lSolution.innerHTML="",sCustomList=null,oSolution=null,iDefinitionFind=0,iDefinitionCount=0;Boolean(!t.find((e=>!e.filenameUTF8)));for(const e of t){const n=await e.getData(new zip.TextWriter);if(e.filename.includes("definition.json")&&!e.filename.includes("Connector/")||e.filename.includes("Workflows/")&&!e.filename.includes("apisMap")&&!e.filename.includes("connectionsMap")){if(o++,iDefinitionFind==iDefinitionCount){pLoading.innerHTML="Flow Found...Loading...",review(e,"flow",n,!0);let t=document.createElement("li");t.innerHTML=e.filename.replace("Workflows/","").replace(regExpFileID,"").replace("-.json",""),t.value=o,lSolution.appendChild(t),t.addEventListener("click",(function(){review(e,"flow",n,!1)}))}else{tSolution.style="display: block",divDivider.style="display: block",lSolution.style="display: block; height:124px; overflow-y:auto; overflow-x:hidden";const t=document.createElement("li"),i=document.createTextNode(e.filename.replace("Workflows/","").replace(regExpFileID,"").replace("-.json",""));t.appendChild(i),t.value=o,lSolution.appendChild(t),t.addEventListener("click",(function(){review(e,"flow",n,!1)})),review(e,"flow",n,!0)}iDefinitionCount++}else if(e.filename.includes("definition.json")&&e.filename.includes("Connector/")){const e=JSON.parse(n);aConnectors.push({name:e.info.title,description:e.info.description,host:e.host})}else e.filename.includes("customizations.xml")?review(e,"customizations",n):e.filename.includes("solution.xml")?review(e,"solution",n,!1):e.filename.includes("environmentvariabledefinition.xml")?review(e,"environmentVar",n,!1):e.filename.includes("complexityConfig.json")?review(e,"complexity",n,!1):e.filename.includes("namingConfig.json")?review(e,"naming",n,!1):e.filename.includes("scoringConfig.json")?review(e,"scoring",n,!1):e.filename.includes("ratingsConfig.json")&&review(e,"ratings",n,!1)}}0!=iDefinitionCount||pLoading.innerHTML.includes("Updated")||(pLoading.innerHTML="No Flows Found in Zip"),bUpdate&&UpdateConfigs(),await n.close()}else pLoading.innerHTML="No a Zip file"}catch(e){pLoading.innerHTML="Unexpected Error: "+e.message}}async function review(e,n,t,o){try{if("flow"==n){sDefinitionParsed=JSON.parse(t),butReview.style="display:block;  width:100%;",butDiagram.style="display:block;  width:100%;",butReport.style="display:block;  width:100%;",butExcept.style="display:block;  width:100%;",butDefinition.style="width:100%; display:block",oReport=null;let n="";if(e.filename.match(regExpFileID)&&(n=e.filename.match(regExpFileID)[0]),oReport=CreateReview(t,"unknown",n,aComplexity,oNaming,aConnectionTier,""),""==oReport.error){if(pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+oReport.name,"unknown"==oReport.name&&null!=sCustomList){let e;try{e=sCustomList.ImportExportXml.Workflows.Workflow.find((e=>e.WorkflowId.toUpperCase()=="{"+oReport.id+"}".toUpperCase())),butSolution.style.display="block"}catch(n){e=sCustomList.ImportExportXml.Workflows.Workflow}null!=e&&null!=e&&(pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+e.Name,oReport.name=e.Name)}if(o&&aExceptions.push(oReport),!o||bFirstFlow){let e;oSavedDef=sDefinitionParsed,oSaved=oReport,oHTML=generateReport(oReport,sReviewTemplate,sReportTemplate,e),""!=pLoading.innerHTML&&null!=pLoading.innerHTML&&(e=pLoading.innerHTML.replace("_img src=_assets_img_old flow grey fill.svg__&nbsp;","").replace('<img src="assets/img/old flow grey fill.svg">',"")),butReview.style="display:block;  width:100%;",butDiagram.style="display:block;  width:100%;",butReport.style="display:block;  width:100%;",butExcept.style="display:block;  width:100%;",butData.style="display:block;",spanVersion.style="display:none;",divCSV.style="display:block; width:100%;",divAdmin.style="display:none;"}}else pLoading.innerHTML=oReport.error,spanVersion.style="display:block;",divCSV.style="display:none;"}else if("customizations"==n){butSolution.style.display="block",sCustomList=xmlToJson.parse(t);let e="",n="",o="",i="",a="",s="",l="";e=null!=sCustomList?.ImportExportXml?.connectionreferences?.connectionreference?sCustomList.ImportExportXml.connectionreferences.connectionreference:[],n=null!=sCustomList?.ImportExportXml?.Entities?.Entity?sCustomList.ImportExportXml.Entities.Entity:[],o=null!=sCustomList?.ImportExportXml?.FieldSecurityProfiles?.FieldSecurityProfile?sCustomList.ImportExportXml.FieldSecurityProfile.FieldSecurityProfiles:[],i=null!=sCustomList?.ImportExportXml?.CanvasApps?.CanvasApp?sCustomList.ImportExportXml.CanvasApps.CanvasApp:[],a=null!=sCustomList?.ImportExportXml?.CustomControls?.CustomControl?sCustomList.ImportExportXml.CustomControls.CustomControl:[],s=null!=sCustomList?.ImportExportXml?.Roles?.Role?sCustomList.ImportExportXml.Roles.Role:[],l=null!=sCustomList?.ImportExportXml?.Languages?.Language?sCustomList.ImportExportXml.Languages.Language:"",oSolution={Flows:sCustomList.ImportExportXml.Workflows.Workflow,ConnectionRefs:e,Tables:n,SecurityProfile:o,CanvasApps:i,CustomControls:a,Roles:s,LanguageCode:l}}else if("solution"==n)oDependencies=xmlToJson.parse(t);else if("environmentVar"==n)aEnvironmentVar.push(xmlToJson.parse(t));else if("complexity"==n){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let e=JSON.parse(t).aComplexityTemplate;checkArray("Name","Complexity",e)?(oConfigReference={...oConfigReference,complexity:JSON.parse(t).sReference},aComplexity=e,pLoading.innerHTML=pLoading.innerHTML+"<p>Complexity Config Updated</p>",bUpdate=!0):(pLoading.innerHTML=pLoading.innerHTML+"<p>Complexity Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("naming"==n){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let e=JSON.parse(t).oNamingTemplate;checkArray("Type","Letter",e.data)&&Object.hasOwn(e,"char")?(oConfigReference={...oConfigReference,naming:e.sReference},oNaming=e,pLoading.innerHTML=pLoading.innerHTML+"<p> Naming Config Updated</p>",bUpdate=!0):(pLoading.innerHTML=pLoading.innerHTML+"<p> Naming Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("scoring"==n){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let e=JSON.parse(t).aScoringTemplate;checkArray("Name","Score",e)&&20==e.length?(oConfigReference={...oConfigReference,score:JSON.parse(t).sReference},aScoring=e,pLoading.innerHTML=pLoading.innerHTML+"<p>Scoring Config Updated</p>",bUpdate=!0):(pLoading.innerHTML=pLoading.innerHTML+"<p>Scoring Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("ratings"==n){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let e=JSON.parse(t).oRatingsTemplate;checkRatings(e)?(oConfigReference={...oConfigReference,ratings:JSON.parse(t).sReference},oRatings=e,pLoading.innerHTML=pLoading.innerHTML+"<p>Ratings Config Updated</p>",bUpdate=!0):(pLoading.innerHTML=pLoading.innerHTML+"<p>Ratings Config Failed, please check JSON</p>",pLoading.style.color="red")}}catch(e){pLoading.innerHTML="Unexpected Error: "+e,pLoading.style.color="red"}}function checkArray(e,n,t){let o=0;for(o=0;o<t.length;o++){if(!Object.hasOwn(t[o],e))return!1;if(!Object.hasOwn(t[o],n))return!1}return!0}async function fetchAPIData(e,n){try{const t={headers:{Authorization:n}},o=await fetch(e,t);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);return await o.json()}catch(e){}}fileInput.onchange=selectFile,fileInputButton.onclick=()=>fileInput.dispatchEvent(new MouseEvent("click")),"launchQueue"in window&&launchQueue.setConsumer((async e=>{for(const n of e.files){unpackNestedZipFiles(await n.getFile())}}));